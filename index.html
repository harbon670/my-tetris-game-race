<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Funny Turbo Drift</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }
        body { background: #000; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        #game-wrapper { position: relative; width: 320px; height: 500px; border: 3px solid #444; background: #0a0a0a; }
        canvas { display: block; width: 100%; height: 100%; }
        #top-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; display: flex; justify-content: space-between; z-index: 10; pointer-events: none; }
        #score-val { color: #0ff; font-size: 24px; font-weight: bold; }
        #pause-btn { background: #333; color: #fff; border: 1px solid #0ff; padding: 5px; cursor: pointer; pointer-events: auto; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 20; text-align: center; }
        #funny-phrase { color: #f05; font-size: 20px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="top-bar">
        <div id="score-val">0000</div>
        <button id="pause-btn">ПАУЗА</button>
    </div>
    <canvas id="game"></canvas>
    <div id="pause-screen" class="screen"><h1>ПАУЗА</h1><p>Кликни для продолжения</p></div>
    <div id="dead-screen" class="screen">
        <div id="funny-phrase"></div>
        <p id="final-score"></p>
        <h2>РЕСТАРТ?</h2>
        <p>(нажми в любое место)</p>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreVal = document.getElementById('score-val');
    const deadScreen = document.getElementById('dead-screen');
    const pauseScreen = document.getElementById('pause-screen');
    const pauseBtn = document.getElementById('pause-btn');

    canvas.width = 320; canvas.height = 500;
    const B = 16, L_LEFT = 6, L_RIGHT = 14;
    let score = 0, speed = 1.0, isDead = false, isPaused = false;
    let px = L_LEFT, tx = L_LEFT, enemies = [], lastSpawn = 0;

    const phrases = ["Права купил?", "Столб победил!", "Минус тачка!", "Красиво летел!", "Не гоняйте, пацаны"];
    const car = [[0,1,0],[1,1,1],[0,1,0],[1,0,1]];

    // ГЛАВНОЕ ИСПРАВЛЕНИЕ: Один обработчик на всё окно
    window.addEventListener('mousedown', (e) => handleAction(e.clientX));
    window.addEventListener('touchstart', (e) => {
        handleAction(e.touches[0].clientX);
    }, {passive: false});

    function handleAction(clientX) {
        if (isDead) { reset(); return; }
        if (isPaused) { togglePause(); return; }

        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        tx = (x < rect.width / 2) ? L_LEFT : L_RIGHT;
    }

    pauseBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        togglePause();
    });

    function togglePause() {
        isPaused = !isPaused;
        pauseScreen.style.display = isPaused ? 'flex' : 'none';
    }

    function reset() {
        score = 0; speed = 1.0; isDead = false; isPaused = false;
        enemies = []; px = tx = L_LEFT;
        deadScreen.style.display = 'none';
        scoreVal.innerText = "0000";
    }

    function draw(x, y, m, color) {
        ctx.fillStyle = color;
        m.forEach((row, dy) => row.forEach((val, dx) => {
            if (val) ctx.fillRect((x + dx) * B, (y + dy) * B, B - 1, B - 1);
        }));
    }

    function update() {
        if (isPaused) { requestAnimationFrame(update); return; }
        ctx.clearRect(0, 0, 320, 500);

        if (!isDead) {
            px += (tx - px) * 0.2;
            draw(px, 24, car, "#0ff");

            let now = Date.now();
            if (now - lastSpawn > 1000/speed) {
                enemies.push({ x: Math.random() > 0.5 ? L_LEFT : L_RIGHT, y: -5, c: "#f05" });
                lastSpawn = now;
            }
        }

        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            if (!isDead) e.y += speed * 0.2;
            draw(e.x, e.y, car, e.c);

            // Коллизия
            if (!isDead && Math.abs(px - e.x) < 2 && Math.abs(24 - e.y) < 3) {
                isDead = true;
                document.getElementById('funny-phrase').innerText = phrases[Math.floor(Math.random()*phrases.length)];
                document.getElementById('final-score').innerText = "СЧЕТ: " + score;
                deadScreen.style.display = 'flex';
            }

            if (e.y > 32) {
                enemies.splice(i, 1);
                score += 10;
                scoreVal.innerText = score.toString().padStart(4, '0');
                speed += 0.02;
            }
        }
        requestAnimationFrame(update);
    }
    update();
</script>
</body>
</html>
